# Assignment 09

## Summary 
 In this assignment I spun up a cluster with zookeeper,kafka and mids container.  
 In the mids container I created api server using flask. There were two flavors of flask api written.  
 1) Simple : Here I the return http get request with simple strings  
 2) Complex : Here I return http get request with logging the event with kafka topic and also returning string.  
 
 # Tasks 
 
 I ran the following steps and commands to achieve the results  
 
 ## Create the docker compose yaml file and then spin up the cluster with zookeeper, kafka and mids conatiner.  
 ```
 vi docker-compose.yml
 docker-compose up -d  
```

 ## The docker compose yml file created was the following 

```
---
version: '2'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 32181
      ZOOKEEPER_TICK_TIME: 2000
    expose:
      - "2181"
      - "2888"
      - "32181"
      - "3888"
    extra_hosts:
      - "moby:127.0.0.1"

  kafka:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:32181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    expose:
      - "9092"
      - "29092"
    extra_hosts:
      - "moby:127.0.0.1"

  mids:
    image: midsw205/base:0.1.8
    stdin_open: true
    tty: true
    volumes:
      - ~/w205:/w205
    expose:
      - "5000"
    ports:
      - "5000:5000"
    extra_hosts:
      - "moby:127.0.0.1"
     
```
 ## Created simple game api with following code 
```python
#!/usr/bin/env python
from flask import Flask
app = Flask(__name__)
events_topic = 'events'

@app.route("/")
def default_response():
    return "\nThis is the default response!\n"

@app.route("/buy_a_sword")
def purchase_sword():
    # business logic to purchase sword
        return "\nSword Purchased!\n"


@app.route("/join_guild/<guildname>")
def join_guild(guildname):
    #join the guild
    return ("\nJoined the Guild: %s\n" %(guildname))


``` 
 ## Run the simple game api using python and flask . It generates the return output for three urls first is default, second is buy a sword and third is join a guild with guild name specified in the url  
 ```
 docker-compose exec mids env FLASK_APP=/w205/assignment-09-anupjha10/simple_game_api.py flask run
 ```
 ## Test the simple_game_api using curl
 
 ```
 docker-compose exec mids curl http://localhost:5000/
 docker-compose exec mids curl http://localhost:5000/buy_a_sword
 docker-compose exec mids curl http://localhost:5000/join_guild/test_guild1
 ```
 ## The output of the test is the following  
 ```
 This is the default response!
 Sword Purchased!
 Joined the Guild: test_guild1
 ```
 
 ## Exit the simple game api using ctr+c
 
 ## Create a kafka topic called events 
 ```
 docker-compose exec kafka kafka-topics --create --topic events --partitions 1 --replication-factor 1 --if-not-exists --zookeeper zookeeper:32181
 ```
 
 ## Create the complex game api using the following code 

 ```python
#!/usr/bin/env python
from kafka import KafkaProducer
from flask import Flask
app = Flask(__name__)
event_logger = KafkaProducer(bootstrap_servers='kafka:29092')
events_topic = 'events'

@app.route("/")
def default_response():
    event_logger.send(events_topic, 'default'.encode())
    return "\nThis is the default response!\n"

@app.route("/buy_a_sword")
def purchase_sword():
    # business logic to purchase sword
    event_logger.send(events_topic, 'Sword Purchased!'.encode())
    return "\nSword Purchased!\n"


@app.route("/join_guild/<guildname>")
def join_guild(guildname):
    #join the guild
    # log event to kafka
    event_logger.send(events_topic, ("Joined the Guild: %s" %(guildname)).encode())
    return ("\nJoined the Guild: %s\n" %(guildname))



 ```
 ## Run the complex game api which not only returns string to the http request but also logs the messages into kafka topic created.The messages are generated by the api server and logged into kafka topic. Whenever a http request is called the flask api server catches the request and calls the appropriate function. The function in turn publishes the messages to the kafka topic so that it can be consumed by the consumers of the kafka topic.
 ```
 docker-compose exec mids env FLASK_APP=/w205/assignment-09-anupjha10/complex_game_api.py flask run
 ```
 ## Test the complex game using curl  
 
 ```
 docker-compose exec mids curl http://localhost:5000/
 docker-compose exec mids curl http://localhost:5000/buy_a_sword
 docker-compose exec mids curl http://localhost:5000/join_guild/test_guild1
 ```
 
 ## The output is  
 
 ```
 This is the default response!
 Sword Purchased!
 Joined the Guild: test_guild1
 ```
 ## Consume the messages created in kafka using kafkacat 
 ```
 docker-compose exec mids bash -c "kafkacat -C -b kafka:29092 -t events -o beginning -e"
 ```
 ## The output is 
 ```
 default
 Sword Purchased!
 Joined the Guild: test_guild1
 % Reached end of topic events [0] at offset 9: exiting
 ```
 ## We see that the api server is able to log the events in the kafka server. Different events generate different messages in the kafka queue of the topic.

 ## Exit the complex game using ctrl+c
 
 ## Bring down the cluster 
 ```
 docker-compose down
 ```
 ## Check the status of the cluster 
 ```
 docker-compose ps
 docker ps -a
 ```
